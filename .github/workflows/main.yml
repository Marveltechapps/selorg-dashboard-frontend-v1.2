name: Deploy Selorg Dashboard Frontend (Docker)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Frontend to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script: |
            set -e
      
            echo "=============================="
            echo "üöÄ FRONTEND DEPLOYMENT STARTED"
            echo "=============================="
      
            FRONTEND_DIR="/home/ubuntu/selorg/selorg-dashboard-frontend-v1.2"   # ‚úÖ updated
            DOCKERFILE="/home/ubuntu/selorg/Dockerfiles/Dockerfile-frontend"
            ENV_FILE="/home/ubuntu/selorg/envs/frontend.env"
      
            IMAGE_NAME="selorg-frontend"
            CONTAINER_NAME="selorg-frontend"
      
            cd $FRONTEND_DIR
      
            echo "üßπ Clean repo & pull latest code"
            git fetch origin
            git checkout main
            git reset --hard origin/main
            git clean -fd
      
            echo "üì¶ Load Vite environment variables"
            set -a
            source $ENV_FILE
            set +a
      
            COMMIT=$(git rev-parse --short HEAD)
            NEW_IMAGE="${IMAGE_NAME}:${COMMIT}"
            LATEST_IMAGE="${IMAGE_NAME}:latest"
            BACKUP_IMAGE="${IMAGE_NAME}:backup"
      
            echo "üìå Commit: $COMMIT"
      
            echo "üì¶ Backup previous image"
            sudo docker image inspect $LATEST_IMAGE >/dev/null 2>&1 && sudo docker tag $LATEST_IMAGE $BACKUP_IMAGE || true
      
            echo "üê≥ Build frontend image"
            sudo docker build \
              -t $NEW_IMAGE \
              -f $DOCKERFILE \
              --build-arg VITE_API_BASE_URL="$VITE_API_BASE_URL" \
              .
      
            sudo docker tag $NEW_IMAGE $LATEST_IMAGE
      
            echo "üõë Remove old container"
            sudo docker stop $CONTAINER_NAME || true
            sudo docker rm $CONTAINER_NAME || true
      
            echo "üöÄ Start new frontend container"
            sudo docker run -d \
              --name $CONTAINER_NAME \
              --restart always \
              --network selorg-net \
              -p 127.0.0.1:8080:80 \
              $LATEST_IMAGE
      
            echo "‚è≥ Waiting for nginx container boot..."
            sleep 5
      
            echo "üîç Health check"
            if curl -f http://127.0.0.1:8080 >/dev/null 2>&1; then
              echo "‚úÖ Frontend deployed successfully!"
            else
              echo "‚ùå Deployment failed ‚Äî rolling back"
      
              sudo docker logs $CONTAINER_NAME --tail 80 || true
              sudo docker rm -f $CONTAINER_NAME || true
      
              if sudo docker image inspect $BACKUP_IMAGE >/dev/null 2>&1; then
                sudo docker tag $BACKUP_IMAGE $LATEST_IMAGE
                sudo docker run -d \
                  --name $CONTAINER_NAME \
                  --restart always \
                  --network selorg-net \
                  -p 127.0.0.1:8080:80 \
                  $LATEST_IMAGE
                echo "‚úÖ Rollback successful"
              else
                echo "‚ö†Ô∏è No backup image available"
                exit 1
              fi
            fi
      
            sudo docker image prune -af
      
            echo "=============================="
            echo "üéâ FRONTEND DEPLOYMENT FINISHED"
            echo "=============================="
